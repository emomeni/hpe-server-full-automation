---

- name: "Ensure common packages are installed"
  ansible.builtin.package:
    name:
      - vim
      - curl
      - wget
      - net-tools
    state: present
  when:
    - ansible_system == 'Linux'
    - ansible_os_family in ['RedHat', 'Debian']

- name: "Configure NTP via chrony"
  ansible.builtin.copy:
    dest: /etc/chrony.conf
    content: |
      {% set chrony_servers = post_install_ntp_servers | default(ilo_ntp_servers | default([])) %}
      {% if chrony_servers | length == 0 %}
      server 0.pool.ntp.org iburst
      server 1.pool.ntp.org iburst
      {% else %}
      {% for server in chrony_servers %}
      server {{ server }} iburst
      {% endfor %}
      {% endif %}
      driftfile /var/lib/chrony/drift
  notify: restart chrony
  when:
    - ansible_system == 'Linux'
    - ansible_os_family in ['RedHat', 'Debian']

- name: "Ensure chronyd is running"
  ansible.builtin.service:
    name: chronyd
    state: started
    enabled: true
  when:
    - ansible_system == 'Linux'
    - ansible_os_family in ['RedHat', 'Debian']

- name: "Reset cached ops SSH public key"
  ansible.builtin.set_fact:
    post_install_ops_pubkey_effective: ""
  no_log: true

- name: "Set ops SSH public key from variable"
  ansible.builtin.set_fact:
    post_install_ops_pubkey_effective: "{{ post_install_ops_pubkey | default('', true) }}"
  when: post_install_ops_pubkey | default('', true) | length > 0
  no_log: true

- name: "Load ops SSH public key from file"
  ansible.builtin.set_fact:
    post_install_ops_pubkey_effective: "{{ lookup('file', post_install_ops_pubkey_file) }}"
  when:
    - post_install_ops_pubkey_effective | default('', true) | length == 0
    - post_install_ops_pubkey_file | default('', true) | length > 0
  no_log: true

- name: "Add authorized SSH key for ops"
  ansible.builtin.authorized_key:
    user: root
    state: present
    key: "{{ post_install_ops_pubkey_effective }}"
  when:
    - ansible_system == 'Linux'
    - post_install_ops_pubkey_effective | default('', true) | length > 0
  no_log: true

- name: "Configure remote syslog target"
  ansible.builtin.copy:
    dest: "{{ post_install_syslog_conf_path }}"
    content: "{{ (post_install_syslog_targets | default([]) | map('regex_replace', '^', '*.* @@') | join('\n')) ~ '\n' }}"
    mode: '0644'
  notify: restart rsyslog
  when:
    - ansible_system == 'Linux'
    - ansible_os_family in ['RedHat', 'Debian']
    - (post_install_syslog_targets | default([])) | length > 0

- name: "Remove remote syslog configuration when no targets are defined"
  ansible.builtin.file:
    path: "{{ post_install_syslog_conf_path }}"
    state: absent
  notify: restart rsyslog
  when:
    - ansible_system == 'Linux'
    - ansible_os_family in ['RedHat', 'Debian']
    - (post_install_syslog_targets | default([])) | length == 0

- name: "Install monitoring agent (placeholder)"
  ansible.builtin.debug:
    msg: "Install your monitoring agent here (Zabbix, Prometheus node_exporter, etc.)"

- name: "Install backup agent (placeholder)"
  ansible.builtin.debug:
    msg: "Install your backup agent here (Veeam, etc.)"
