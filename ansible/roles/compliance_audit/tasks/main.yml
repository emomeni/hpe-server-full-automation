---

- name: "Validate firmware baseline is defined"
  ansible.builtin.assert:
    that:
      - firmware_expected is defined
      - firmware_expected.bios is defined
      - firmware_expected.bios | string | length > 0
    fail_msg: "Define firmware_expected.bios (for example via host_vars/group_vars) before running the compliance_audit role."

- name: "Login to iLO for compliance audit"
  ansible.builtin.include_role:
    name: redfish_session
    tasks_from: login
  vars:
    redfish_host: "{{ ansible_host }}"
    redfish_username: "{{ ilo_admin_username }}"
    redfish_password: "{{ ilo_admin_password }}"
    redfish_root: "{{ redfish_root }}"
    redfish_validate_certs: "{{ ilo_validate_certs | bool }}"
    redfish_session_token_var: "ilo_x_auth_token"
    redfish_session_location_var: "ilo_session_location"
    redfish_login_no_log: true

- name: "Get system info for firmware"
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}{{ redfish_system_path }}"
    method: GET
    headers:
      X-Auth-Token: "{{ ilo_x_auth_token }}"
    validate_certs: "{{ ilo_validate_certs | bool }}"
  register: system_info

- name: "Store audit facts"
  ansible.builtin.set_fact:
    hpe_audit_firmware:
      bios_version: "{{ system_info.json.BiosVersion | default('unknown') }}"
      model: "{{ system_info.json.Model | default('unknown') }}"
      serial: "{{ system_info.json.SerialNumber | default('unknown') }}"

- name: "Compare BIOS with expected baseline"
  ansible.builtin.set_fact:
    hpe_bios_compliant: "{{ ((hpe_audit_firmware.bios_version | default('')) == firmware_expected.bios) | bool }}"

- name: "Show audit summary"
  ansible.builtin.debug:
    msg:
      - "Host: {{ inventory_hostname }}"
      - "Model: {{ hpe_audit_firmware.model }}"
      - "Serial: {{ hpe_audit_firmware.serial }}"
      - "BIOS current: {{ hpe_audit_firmware.bios_version }} | expected: {{ firmware_expected.bios }}"
      - "Compliant: {{ hpe_bios_compliant }}"

- name: "Logout iLO session"
  ansible.builtin.include_role:
    name: redfish_session
    tasks_from: logout
  vars:
    redfish_host: "{{ ansible_host }}"
    redfish_validate_certs: "{{ ilo_validate_certs | bool }}"
    redfish_session_token_var: "ilo_x_auth_token"
    redfish_session_location_var: "ilo_session_location"
