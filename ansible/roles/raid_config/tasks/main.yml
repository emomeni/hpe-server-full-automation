---

- name: "Login to iLO for RAID discovery"
  ansible.builtin.include_role:
    name: redfish_session
    tasks_from: login
  vars:
    redfish_host: "{{ ansible_host }}"
    redfish_username: "{{ ilo_admin_username }}"
    redfish_password: "{{ ilo_admin_password }}"
    redfish_root: "{{ redfish_root }}"
    redfish_validate_certs: "{{ ilo_validate_certs | bool }}"
    redfish_session_token_var: "ilo_x_auth_token"
    redfish_session_location_var: "ilo_session_location"
    redfish_login_no_log: true

- name: "Get storage controllers (extend for SmartArray)"
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}{{ redfish_system_path }}/Storage"
    method: GET
    headers:
      X-Auth-Token: "{{ ilo_x_auth_token }}"
    validate_certs: "{{ ilo_validate_certs | bool }}"
  register: storage

- name: "Summarize discovered storage controllers"
  ansible.builtin.debug:
    msg: "Discovered {{ storage.json.Members | default([]) | length }} storage controller(s) via Redfish."

- name: "Show detailed storage payload when running verbosely"
  ansible.builtin.debug:
    var: storage.json
  when: ansible_verbosity | int > 1

# Extend here: loop over Members, call OEM SmartArray actions to create LDs

- name: "Logout iLO"
  ansible.builtin.include_role:
    name: redfish_session
    tasks_from: logout
  vars:
    redfish_host: "{{ ansible_host }}"
    redfish_validate_certs: "{{ ilo_validate_certs | bool }}"
    redfish_session_token_var: "ilo_x_auth_token"
    redfish_session_location_var: "ilo_session_location"
