---

- name: "Login to iLO for BIOS configuration"
  ansible.builtin.include_role:
    name: redfish_session
    tasks_from: login
  vars:
    redfish_host: "{{ ansible_host }}"
    redfish_username: "{{ ilo_admin_username }}"
    redfish_password: "{{ ilo_admin_password }}"
    redfish_root: "{{ redfish_root }}"
    redfish_validate_certs: "{{ ilo_validate_certs | bool }}"
    redfish_session_token_var: "ilo_x_auth_token"
    redfish_session_location_var: "ilo_session_location"
    redfish_login_no_log: true

- name: "Load BIOS profile JSON"
  ansible.builtin.slurp:
    src: "{{ role_path }}/files/bios_profile.json"
  register: bios_profile_raw

- name: "Decode BIOS profile"
  ansible.builtin.set_fact:
    bios_profile: "{{ bios_profile_raw.content | b64decode | from_json }}"

- name: "Apply BIOS settings"
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}{{ redfish_system_path }}/Bios/Settings"
    method: PATCH
    headers:
      Content-Type: "application/json"
      X-Auth-Token: "{{ ilo_x_auth_token }}"
    body_format: json
    body: "{{ bios_profile }}"
    validate_certs: "{{ ilo_validate_certs | bool }}"
  register: bios_apply
  failed_when: bios_apply.status not in [200, 204]

- name: "Request restart to apply BIOS settings"
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}{{ redfish_system_path }}/Actions/ComputerSystem.Reset"
    method: POST
    headers:
      Content-Type: "application/json"
      X-Auth-Token: "{{ ilo_x_auth_token }}"
    body_format: json
    body:
      ResetType: "ForceRestart"
    validate_certs: "{{ ilo_validate_certs | bool }}"
  when: bios_apply.status in [200, 204]

- name: "Logout iLO"
  ansible.builtin.include_role:
    name: redfish_session
    tasks_from: logout
  vars:
    redfish_host: "{{ ansible_host }}"
    redfish_validate_certs: "{{ ilo_validate_certs | bool }}"
    redfish_session_token_var: "ilo_x_auth_token"
    redfish_session_location_var: "ilo_session_location"
