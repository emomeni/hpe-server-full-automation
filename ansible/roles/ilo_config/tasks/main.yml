---

- name: "Validate iLO admin credentials are provided"
  ansible.builtin.assert:
    that:
      - ilo_admin_username | length > 0
      - ilo_admin_password | length > 0
    fail_msg: "ilo_admin_username and ilo_admin_password must be provided via env or vault secrets."

- name: "Login to iLO as automation admin"
  ansible.builtin.include_role:
    name: redfish_session
    tasks_from: login
  vars:
    redfish_host: "{{ ansible_host }}"
    redfish_username: "{{ ilo_admin_username }}"
    redfish_password: "{{ ilo_admin_password }}"
    redfish_root: "{{ redfish_root }}"
    redfish_validate_certs: "{{ ilo_validate_certs | bool }}"
    redfish_session_token_var: "ilo_x_auth_token"
    redfish_session_location_var: "ilo_session_location"
    redfish_login_no_log: true

- name: "Configure iLO DateTime and NTP"
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}{{ redfish_root }}/Managers/1/DateTime"
    method: PATCH
    headers:
      Content-Type: "application/json"
      X-Auth-Token: "{{ ilo_x_auth_token }}"
    body_format: json
    body: "{{ {'Timezone': ilo_timezone} | combine({'NTPServers': ilo_ntp_servers} if (ilo_ntp_servers | length) > 0 else {}) }}"
    validate_certs: "{{ ilo_validate_certs | bool }}"
  register: datetime_cfg
  failed_when: datetime_cfg.status not in [200, 204]

- name: "Enable HTTPS on default port (placeholder)"
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}{{ redfish_root }}/Managers/1/NetworkService"
    method: PATCH
    headers:
      Content-Type: "application/json"
      X-Auth-Token: "{{ ilo_x_auth_token }}"
    body_format: json
    body:
      HTTPS:
        Port: 443
        ProtocolEnabled: true
    validate_certs: "{{ ilo_validate_certs | bool }}"
  register: https_cfg
  failed_when: https_cfg.status not in [200, 204]

- name: "Logout iLO session"
  ansible.builtin.include_role:
    name: redfish_session
    tasks_from: logout
  vars:
    redfish_host: "{{ ansible_host }}"
    redfish_validate_certs: "{{ ilo_validate_certs | bool }}"
    redfish_session_token_var: "ilo_x_auth_token"
    redfish_session_location_var: "ilo_session_location"
