---

- name: "Validate iLO bootstrap credentials are provided"
  ansible.builtin.assert:
    that:
      - ilo_default_username | length > 0
      - ilo_default_password | length > 0
      - ilo_admin_username | length > 0
      - ilo_admin_password | length > 0
    fail_msg: "Set ILO default/admin credentials via environment variables or vault secrets before running bootstrap."

- name: "Bootstrap iLO: authenticate with default credentials"
  ansible.builtin.include_role:
    name: redfish_session
    tasks_from: login
  vars:
    redfish_host: "{{ ansible_host }}"
    redfish_username: "{{ ilo_default_username }}"
    redfish_password: "{{ ilo_default_password }}"
    redfish_root: "{{ redfish_root }}"
    redfish_validate_certs: "{{ ilo_validate_certs | bool }}"
    redfish_session_token_var: "ilo_x_auth_token"
    redfish_session_location_var: "ilo_session_location"
    redfish_login_no_log: true

- name: "Create automation admin account"
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}{{ redfish_account_path }}"
    method: POST
    headers:
      Content-Type: "application/json"
      X-Auth-Token: "{{ ilo_x_auth_token }}"
    body_format: json
    body:
      UserName: "{{ ilo_admin_username }}"
      Password: "{{ ilo_admin_password }}"
      RoleId: "Administrator"
      Enabled: true
    validate_certs: "{{ ilo_validate_certs | bool }}"
  register: new_account
  failed_when: new_account.status not in [200, 201, 409]
  no_log: true

- name: "Reset discovered default account URI"
  ansible.builtin.set_fact:
    ilo_default_account_uri: ""
  no_log: true

- name: "Enumerate existing iLO accounts"
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}{{ redfish_account_path }}"
    method: GET
    headers:
      X-Auth-Token: "{{ ilo_x_auth_token }}"
    validate_certs: "{{ ilo_validate_certs | bool }}"
  register: ilo_accounts

- name: "Gather account member details"
  ansible.builtin.uri:
    url: >-
      https://{{ ansible_host }}{{ item['@odata.id'] | default('') | regex_replace('^https?://[^/]+', '') }}
    method: GET
    headers:
      X-Auth-Token: "{{ ilo_x_auth_token }}"
    validate_certs: "{{ ilo_validate_certs | bool }}"
  loop: "{{ ilo_accounts.json.Members | default([]) }}"
  when: item.get('@odata.id') | default('') | length > 0
  register: ilo_account_details

- name: "Identify default iLO account URI"
  ansible.builtin.set_fact:
    ilo_default_account_uri: "{{ account_uri }}"
  vars:
    account_uri: >-
      {{ item.json.get('@odata.id') | default(item.invocation.module_args.url | regex_replace('^https?://[^/]+', '')) }}
  loop: "{{ ilo_account_details.results | default([]) }}"
  when:
    - item.json is defined
    - item.json.get('UserName', '') | lower == ilo_default_username | lower
    - (item.status | default(0)) in [200]

- name: "Disable default iLO account"
  ansible.builtin.uri:
    url: >-
      https://{{ ansible_host }}{{ ilo_default_account_uri | default('') | regex_replace('^https?://[^/]+', '') }}
    method: PATCH
    headers:
      Content-Type: "application/json"
      X-Auth-Token: "{{ ilo_x_auth_token }}"
    body_format: json
    body:
      Enabled: false
    validate_certs: "{{ ilo_validate_certs | bool }}"
  register: disable_default
  failed_when: disable_default.status not in [200, 204]
  no_log: true
  when: ilo_default_account_uri | default('') | length > 0

- name: "Warn if default iLO account was not located"
  ansible.builtin.debug:
    msg: "Default iLO account '{{ ilo_default_username }}' was not found; skipping disable step."
  when: ilo_default_account_uri | default('') | length == 0

- name: "Log out iLO session"
  ansible.builtin.include_role:
    name: redfish_session
    tasks_from: logout
  vars:
    redfish_host: "{{ ansible_host }}"
    redfish_validate_certs: "{{ ilo_validate_certs | bool }}"
    redfish_session_token_var: "ilo_x_auth_token"
    redfish_session_location_var: "ilo_session_location"
